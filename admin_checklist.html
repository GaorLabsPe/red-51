<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Operaciones - Onboarding de Clientes</title>
    <style>
        :root {
            --primary: #7B5C7E;
            --secondary: #1B9AA8;
            --dark: #1a1a2e;
            --light: #f5f5f5;
            --white: #FFFFFF;
            --border-color: #e0e0e0;
            --shadow: 0 4px 25px rgba(0,0,0,0.06);
            --success: #10b981;
            --danger: #dc3545;
            --warning: #f59e0b;
            --info: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--light);
            color: #333;
            line-height: 1.6;
        }
        .header {
            background-color: var(--dark);
            color: var(--white);
            padding: 1.5rem 2rem;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 2rem; }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .card {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        .card h2 {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
        }
        .btn {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(27, 154, 168, 0.3); }
        .btn-secondary { background: #6c757d; }
        .btn-danger { background: var(--danger); }
        .btn-copy {
            background-color: #e2e8f0;
            color: #475569;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 1rem;
            font-size: 0.8rem;
        }
        
        /* Dashboard View */
        #dashboardView .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        #projectList { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .project-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.2s; }
        .project-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.08); transform: translateY(-4px); }
        .project-card-header h3 { margin: 0; color: #333; }
        .project-card-header p { font-size: 0.9rem; color: #666; }
        .progress-bar-container { background-color: var(--light); border-radius: 20px; height: 10px; margin: 1rem 0; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, var(--secondary) 0%, var(--primary) 100%); height: 100%; width: 0%; border-radius: 20px; transition: width 0.5s ease-in-out; }
        .project-card-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #555; }

        /* Project View */
        #projectView .project-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .project-tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; }
        .project-tab-btn { padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-size: 1.1rem; font-weight: 600; color: #999; position: relative; top: 2px; transition: all 0.2s; }
        .project-tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        
        .checklist ul { list-style: none; padding-left: 0; }
        .checklist li { margin-bottom: 1.5rem; }
        .checklist .main-task { font-weight: 700; font-size: 1.2rem; color: var(--dark); display: flex; align-items: center; }
        .checklist .sub-task { padding-left: 2.5rem; margin-top: 1rem; color: #555; font-size: 0.95rem; }
        .checklist .sub-task-header { display: flex; align-items: center; }
        .checklist input[type="checkbox"] { margin-right: 0.8rem; width: 20px; height: 20px; accent-color: var(--secondary); cursor: pointer; flex-shrink: 0; }
        .checklist label { cursor: pointer; }
        .checklist .input-group { margin-top: 0.75rem; padding-left: 2.5rem; }
        .checklist .input-group label { display: block; font-weight: 600; color: #444; margin-bottom: 0.25rem; }
        .checklist .input-group input, .checklist .input-group textarea { width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 8px; }
        
        .details { margin-top: 0.75rem; }
        .details summary { cursor: pointer; font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem; display: flex; align-items: center; }
        .details-content { background-color: #f9fafb; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; font-size: 0.9rem; }
        .details-content pre, code { background-color: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; max-height: 400px;}
        code.inline { padding: 2px 6px; display: inline-block; white-space: normal;}
        
        /* n8n Guide Styles */
        #n8nGuideTabContent h3 { font-size: 1.3rem; color: var(--primary); margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .guide-section { margin-bottom: 2rem; }
        .guide-card { background: #f8fafc; border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
        .guide-card h4 { margin: 0 0 1rem 0; font-size: 1.1rem; color: #333; }
        .guide-card strong { color: var(--dark); }
        .priority-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .priority-dot.critical { background-color: var(--danger); }
        .priority-dot.high { background-color: var(--warning); }
        .priority-dot.low { background-color: var(--success); }
        .guide-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .guide-table th, .guide-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .guide-table th { background-color: var(--light); font-weight: 700; }
        .guide-table tr:hover { background-color: #f8fafc; }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--white); margin: 10% auto; padding: 2.5rem; border-radius: 16px; width: 90%; max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; }
    </style>
</head>
<body>
    <header class="header">
        <h1>Centro de Operaciones</h1>
    </header>

    <main class="container">
        <!-- DASHBOARD VIEW: Shows all projects -->
        <div id="dashboardView">
            <div class="card">
                <div class="dashboard-header">
                    <h2>Mis Proyectos</h2>
                    <button class="btn" onclick="openProjectModal()">+ Crear Nuevo Proyecto</button>
                </div>
                <div id="projectList"></div>
            </div>
        </div>

        <!-- PROJECT VIEW: Shows the checklist for a specific project -->
        <div id="projectView" style="display:none;">
            <div class="card">
                <div class="project-header">
                    <h2 id="projectNameHeader"></h2>
                    <div>
                        <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Volver</button>
                        <button class="btn btn-danger" onclick="deleteCurrentProject()">Eliminar</button>
                    </div>
                </div>

                <div class="project-tabs">
                    <button class="project-tab-btn active" onclick="showProjectTab('checklist')">Checklist de Onboarding</button>
                    <button class="project-tab-btn" onclick="showProjectTab('n8n')">Gu√≠a n8n</button>
                </div>

                <div id="checklistTabContent">
                    <ul id="onboardingChecklist" class="checklist">
                        <!-- Paso 1: Supabase -->
                        <li>
                            <div class="main-task"><input type="checkbox" id="task1" disabled>Paso 1: Configurar Supabase</div>
                            <div class="sub-task">
                                <div class="sub-task-header"><input type="checkbox" id="task1_1"><label for="task1_1">Crear nuevo proyecto en Supabase</label></div>
                                <div class="input-group">
                                    <label for="field_supabaseProjectName">Nombre del Proyecto en Supabase</label>
                                    <input type="text" id="field_supabaseProjectName" placeholder="tienda-de-ana">
                                </div>
                            </div>
                            <div class="sub-task">
                                <div class="sub-task-header"><input type="checkbox" id="task1_2"><label for="task1_2">Ejecutar script SQL de tablas</label></div>
                                <details class="details">
                                    <summary>üìÑ Ver Script SQL <button class="btn-copy" onclick="copySqlScript(this)">Copiar Script</button></summary>
                                    <div class="details-content"><pre id="sqlScript"><code>-- SCRIPT SQL PARA CREAR TABLAS Y POL√çTICAS...</code></pre></div>
                                </details>
                            </div>
                            <div class="sub-task">
                                <div class="sub-task-header"><input type="checkbox" id="task1_3"><label for="task1_3">Registrar credenciales de Supabase</label></div>
                                <div class="input-group">
                                    <label for="field_supabaseUrl">Project URL</label>
                                    <input type="url" id="field_supabaseUrl" placeholder="https://xxxxxxxx.supabase.co">
                                </div>
                                <div class="input-group">
                                    <label for="field_supabaseKey">Project Anon Key</label>
                                    <input type="text" id="field_supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                                </div>
                            </div>
                        </li>
                        <!-- Paso 2: n8n -->
                        <li>
                            <div class="main-task"><input type="checkbox" id="task2" disabled>Paso 2: Configurar n8n</div>
                            <div class="sub-task">
                                <div class="sub-task-header"><input type="checkbox" id="task2_1"><label for="task2_1">Importar y configurar Master Workflow</label></div>
                                <div style="padding-left: 2.5rem; margin-top: 0.5rem;">
                                    <button class="btn" style="background: var(--info);" onclick="showProjectTab('n8n')">Abrir Gu√≠a Detallada de n8n ‚Üí</button>
                                </div>
                            </div>
                            <div class="sub-task">
                                <div class="sub-task-header"><input type="checkbox" id="task2_2"><label for="task2_2">Registrar Webhooks de n8n</label></div>
                                <div class="input-group">
                                    <label for="field_n8nUrl">Webhook URL (del Flujo 1: Nuevo Pedido)</label>
                                    <input type="url" id="field_n8nUrl" placeholder="https://n8n.tudominio.com/webhook/...">
                                </div>
                                <div class="input-group">
                                    <label for="field_n8nStatusUrl">Webhook URL (del Flujo 2: Actualizar Estado)</label>
                                    <input type="url" id="field_n8nStatusUrl" placeholder="https://n8n.tudominio.com/webhook/...">
                                </div>
                            </div>
                        </li>
                        <!-- Paso 3: C√≥digo y Vercel -->
                        <li>
                            <div class="main-task"><input type="checkbox" id="task3" disabled>Paso 3: Desplegar en Vercel</div>
                            <div class="sub-task">
                                <div class="sub-task-header"><input type="checkbox" id="task3_1"><label for="task3_1">Duplicar repositorio Git y desplegar</label></div>
                            </div>
                            <div class="sub-task">
                                <div class="sub-task-header"><input type="checkbox" id="task3_2"><label for="task3_2">Configurar Variables de Entorno en Vercel</label></div>
                            </div>
                            <div class="sub-task">
                                <div class="sub-task-header"><input type="checkbox" id="task3_3"><label for="task3_3">Registrar URL final</label></div>
                                <div class="input-group">
                                    <label for="field_vercelUrl">Vercel Deployed URL</label>
                                    <input type="url" id="field_vercelUrl" placeholder="https://nombre-proyecto.vercel.app">
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <div id="n8nGuideTabContent" style="display:none;">
                     <div class="guide-section">
                        <h2>üöÄ Herramientas n8n</h2>
                        <div class="guide-card">
                            <h4>1. Importar el Master Workflow</h4>
                            <p>Copia todo el c√≥digo JSON de abajo. En n8n, ve a un canvas vac√≠o y presiona <strong>Ctrl+V</strong> (o Cmd+V) para pegar los 4 flujos de una sola vez. Las notas amarillas en el canvas te guiar√°n.</p>
                            <button class="btn-copy" onclick="copySqlScript(this, 'n8nMasterWorkflow')">Copiar Master Workflow</button>
                            <details class="details"><summary>Ver/Ocultar JSON del Workflow</summary><pre id="n8nMasterWorkflow"></pre></details>
                        </div>
                    </div>
                    <div class="guide-section">
                        <h3>üî¥ Cambios Cr√≠ticos (Obligatorios)</h3>
                        <div class="guide-card">
                            <h4>1. Evolution API (EN TODOS LOS NODOS DE WHATSAPP)</h4>
                            <p>Nodos afectados: <code class="inline">Enviar WhatsApp Admin</code>, <code class="inline">Confirmaci√≥n al Cliente</code>, etc.</p>
                            <p><strong>Qu√© cambiar:</strong> URL de tu API, API Key y seleccionar tus credenciales.</p>
                        </div>
                        <div class="guide-card">
                            <h4>2. N√∫mero de WhatsApp del Administrador</h4>
                            <p>Nodo: <code class="inline">Enviar WhatsApp Admin</code></p>
                            <p><strong>Qu√© cambiar:</strong> En Body Parameters ‚Üí number, reemplazar <code class="inline">51905820448</code> por el n√∫mero del admin.</p>
                        </div>
                         <div class="guide-card">
                            <h4>3. Datos de Pago (EN 5 LUGARES)</h4>
                            <p>Nodos: <code class="inline">Formatear Mensaje</code>, <code class="inline">Mensaje 6h</code>, <code class="inline">Mensaje 24h</code>, <code class="inline">Mensaje 48h</code>.</p>
                            <p><strong>Qu√© cambiar:</strong> Reemplazar el n√∫mero de Yape/Plin <code class="inline">975615244</code> y agregar otras cuentas bancarias.</p>
                        </div>
                        <div class="guide-card">
                            <h4>4. URLs de Webhooks y Credenciales Supabase</h4>
                             <p>Aseg√∫rate de copiar las URLs de los webhooks a Vercel y seleccionar las credenciales de Supabase en los nodos correspondientes.</p>
                        </div>
                         <div class="guide-card">
                            <h4>5. URL de la Tienda</h4>
                            <p>Nodo: <code class="inline">Preparar Mensaje de Cancelaci√≥n</code></p>
                            <p><strong>Qu√© cambiar:</strong> Reemplazar la URL por defecto <code class="inline">https://red-51.vercel.app/</code> por la URL de la nueva tienda.</p>
                        </div>
                    </div>
                     <div class="guide-section">
                        <h3>üü° Cambios Recomendados (Alta Prioridad)</h3>
                        <div class="guide-card">
                            <h4>Nombre del Negocio y C√≥digo de Pa√≠s</h4>
                            <p>Busca y reemplaza <code class="inline">"RED51 TECHNOLOGY"</code> y el c√≥digo de pa√≠s <code class="inline">'51'</code> en los nodos de mensajes y formato de tel√©fono si no es para Per√∫.</p>
                        </div>
                    </div>
                    <div class="guide-section">
                        <h3>üìä Tabla Resumen: Prioridad de Cambios</h3>
                        <table class="guide-table">
                            <thead><tr><th>#</th><th>Cambio</th><th>Prioridad</th><th>¬øFalla sin esto?</th></tr></thead>
                            <tbody>
                                <tr><td>1</td><td>Configuraci√≥n Evolution API</td><td><span class="priority-dot critical"></span>Cr√≠tico</td><td>‚úÖ S√ç</td></tr>
                                <tr><td>2</td><td>N√∫mero de WhatsApp del Admin</td><td><span class="priority-dot critical"></span>Cr√≠tico</td><td>‚úÖ S√ç</td></tr>
                                <tr><td>3</td><td>Datos de Pago</td><td><span class="priority-dot critical"></span>Cr√≠tico</td><td>‚ö†Ô∏è Datos incorrectos</td></tr>
                                <tr><td>4</td><td>URLs de Webhooks</td><td><span class="priority-dot critical"></span>Cr√≠tico</td><td>‚úÖ S√ç</td></tr>
                                <tr><td>5</td><td>URL de la Tienda</td><td><span class="priority-dot critical"></span>Cr√≠tico</td><td>‚ö†Ô∏è Link incorrecto</td></tr>
                                <tr><td>6</td><td>Credenciales de Supabase</td><td><span class="priority-dot critical"></span>Cr√≠tico</td><td>‚úÖ S√ç</td></tr>
                                <tr><td>7</td><td>Nombre del Negocio</td><td><span class="priority-dot high"></span>Alta</td><td>‚ùå NO</td></tr>
                                <tr><td>8</td><td>C√≥digo de Pa√≠s</td><td><span class="priority-dot high"></span>Alta</td><td>‚ö†Ô∏è Si no es Per√∫</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="guide-section">
                        <h3>üß™ Pruebas Recomendadas</h3>
                        <div class="guide-card">
                             <ol>
                                <li><strong>Flujo Nuevo Pedido:</strong> Crear un pedido y verificar que admin y cliente reciben los mensajes correctos.</li>
                                <li><strong>Flujo Cambio de Estado:</strong> Cambiar el estado de un pedido en el panel y verificar que el cliente recibe la notificaci√≥n.</li>
                                <li><strong>Flujo Recordatorios y Cancelaci√≥n:</strong> Modificar la fecha de un pedido en la base de datos para simular el paso del tiempo y ejecutar los flujos manualmente para probar los recordatorios y la cancelaci√≥n.</li>
                             </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="projectModal" class="modal"><div class="modal-content">...</div></div>

<script>
    const projectModal = document.getElementById('projectModal');
    const projectForm = document.getElementById('projectForm');
    const projectList = document.getElementById('projectList');
    const dashboardView = document.getElementById('dashboardView');
    const projectView = document.getElementById('projectView');
    
    let projects = [];
    let currentProjectId = null;
    const TOTAL_TASKS = 8;
    
    const sqlScriptContent = `-- 1. TABLA DE CATEGORIAS
CREATE TABLE public.categorias ( id bigint generated by default as identity primary key, nombre text not null, slug text not null unique, icon text, imagen_url text );
-- 2. TABLA DE PRODUCTOS
CREATE TABLE public.productos ( id bigint generated by default as identity primary key, nombre text not null, marca text not null, categoria_id bigint references public.categorias(id) on delete set null, descripcion text, precio numeric not null, stock integer not null default 0, icon text, badge text, activo boolean default true, imagen_url text, variantes jsonb );
-- 3. TABLA DE PEDIDOS
CREATE TABLE public.pedidos ( id uuid default gen_random_uuid() primary key, fecha_pedido timestamp with time zone default timezone('utc'::text, now()) not null, numero_pedido text, nombre_cliente text not null, telefono_cliente text not null, email_cliente text, direccion text, notas text, latitud double precision, longitud double precision, productos jsonb, total numeric not null, cantidad_items integer, estado text default 'pendiente_pago'::text not null );
-- 4. HABILITAR ROW LEVEL SECURITY (RLS)
alter table public.categorias enable row level security; alter table public.productos enable row level security; alter table public.pedidos enable row level security;
-- 5. CREAR POL√çTICAS DE ACCESO (PERMITEN QUE LA TIENDA LEA DATOS P√öBLICOS Y CREE PEDIDOS)
CREATE POLICY "Public categories are viewable" ON public.categorias FOR SELECT USING (true);
CREATE POLICY "Public active products are viewable" ON public.productos FOR SELECT USING (activo = true);
CREATE POLICY "Allow public insert for orders" ON public.pedidos FOR INSERT WITH CHECK (true);
-- 6. POL√çTICAS DE ACCESO PARA EL ADMIN (PERMITEN AL ADMIN AUTENTICADO GESTIONAR TODO)
CREATE POLICY "Allow full access for authenticated users" ON public.categorias FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Allow full access for authenticated users" ON public.productos FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Allow full access for authenticated users" ON public.pedidos FOR ALL USING (auth.role() = 'authenticated');`;
    
    const n8nMasterWorkflowJSON = { "nodes": [ { "parameters": { "jsCode": "// Formatear tel√©fono agregando c√≥digo de pa√≠s si no lo tiene\nconst body = $input.item.json.body;\nconst telefono = body.record.telefono_cliente;\nconst telefonoFormateado = telefono.startsWith('51') ? telefono : '51' + telefono;\n\nreturn {\n  type: body.type,\n  table: body.table,\n  record: {\n    ...body.record,\n    telefono_cliente: telefonoFormateado\n  },\n  old_record: body.old_record,\n  schema: body.schema\n};" }, "id": "51216484-c68e-4304-8266-0afdbd18b26a", "name": "Formatear Tel√©fono", "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [ -1456, 768 ] }, { "parameters": { "method": "POST", "url": "=https://api.red51.site/message/sendText/chatbot", "authentication": "predefinedCredentialType", "nodeCredentialType": "evolutionApi", "sendHeaders": true, "headerParameters": { "parameters": [ { "name": "Content-Type", "value": "application/json" }, { "name": "apikey", "value": "D55E32A4EB2D-4770-B385-B750BD86D958" } ] }, "sendBody": true, "bodyParameters": { "parameters": [ { "name": "number", "value": "={{ $('Formatear Tel√©fono').item.json.record.telefono_cliente }}" }, { "name": "text", "value": "={{$json.mensaje}}" } ] }, "options": {} }, "id": "47ce47da-86e4-47f2-abfc-af30a1471e34", "name": "Enviar WhatsApp al Cliente", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.1, "position": [ -352, 800 ], "notes": "ANOTACI√ìN: Este nodo env√≠a el mensaje de cambio de estado al cliente final.\n\nACCI√ìN: Aseg√∫rate de que tus credenciales de la API de WhatsApp (Evolution API, etc.) est√°n seleccionadas en la secci√≥n 'Credential'." }, { "parameters": { "httpMethod": "POST", "path": "pedidos-webhook", "options": {} }, "id": "8bab1888-a43a-4f58-a32f-b9233f117f5d", "name": "Webhook - Recibir desde Supabase1", "type": "n8n-nodes-base.webhook", "typeVersion": 2, "position": [ -1680, 768 ], "notes": "FLUJO 2: ACTUALIZACI√ìN DE ESTADO\n\nProp√≥sito: Notificar al cliente final cuando el estado de su pedido cambia en el panel de administraci√≥n.\n\nACCI√ìN: Copia la URL de este webhook (Test o Production URL) y p√©gala en la variable de entorno VITE_N8N_STATUS_UPDATE_WEBHOOK_URL de Vercel." }, { "parameters": { "conditions": { "string": [ { "value1": "={{$json.record.estado}}", "operation": "notEqual", "value2": "={{$json.old_record.estado}}" } ] } }, "id": "13ecdeea-f28e-4a76-8fb9-c95c4b2f7dcd", "name": "IF Estado Cambi√≥1", "type": "n8n-nodes-base.if", "typeVersion": 1, "position": [ -1232, 768 ] }, { "parameters": { "value1": "={{ $json.record.estado }}", "rules": { "rules": [ { "operation": "equal", "value2": "=pago_confirmado" }, { "operation": "equal", "value2": "=en_preparacion", "output": 1 }, { "operation": "equal", "value2": "=enviado", "output": 2 }, { "operation": "equal", "value2": "=entregado", "output": 3 } ] } }, "id": "a82d32e6-253d-42a7-845b-337457944f08", "name": "Switch por Estado1", "type": "n8n-nodes-base.switch", "typeVersion": 1, "position": [ -944, 720 ] }, { "parameters": { "assignments": { "assignments": [ { "id": "2a59c8b8-09d8-4da3-944f-3ec81b5878cc", "name": "mensaje", "value": "=üéâ ¬°Genial! Tu pago fue confirmado\n\nHola {{$json.record.nombre_cliente}}, acabamos de recibir tu pago del pedido #{{$json.record.numero_pedido}} üíö\n\nNuestro equipo ya est√° preparando tu pedido con mucho cari√±o. Te avisaremos en cuanto salga rumbo a ti.\n\n¬°Gracias por confiar en nosotros!\n\n_Red51 Technology_", "type": "string" } ] }, "options": {} }, "id": "b82c134b-193a-4448-a13a-ec87a4b4d292", "name": "Set Msg: Pago Confirmado1", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ -656, 528 ], "notes": "ACCI√ìN (Opcional): Personaliza el mensaje que recibe el cliente cuando su pago es confirmado." }, { "parameters": { "assignments": { "assignments": [ { "id": "msg2", "name": "mensaje", "value": "=üë®‚Äçüíª ¬°Tu pedido ya est√° en proceso!\n\nHola ,nuestro equipo est√° preparando tu pedido #{{ $('IF Estado Cambi√≥1').item.json.record.numero_pedido }}{{$json.record.numero_pedido}} con todo el cuidado del mundo üíö\n\nEn cuanto est√© listo para enviarse, te avisamos de inmediato.\n\n¬°Gracias por tu paciencia!\n\nRed51 Technology", "type": "string" }, { "id": "tel2", "name": "telefono_cliente", "value": "={{$json.record.telefono_cliente}}", "type": "string" } ] }, "options": {} }, "id": "0d8acff5-d26f-429e-8026-5e8c9ac01f40", "name": "Set Msg: En Preparaci√≥n1", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ -656, 704 ], "notes": "ACCI√ìN (Opcional): Personaliza el mensaje para el estado 'En Preparaci√≥n'." }, { "parameters": { "assignments": { "assignments": [ { "id": "msg3", "name": "mensaje", "value": "=¬°Tu pedido est√° en camino! üöö\n\nHola {{$json.record.nombre_cliente}}, tu pedido N¬∞ {{$json.record.numero_pedido}} ha sido enviado y va en camino a tu direcci√≥n.\n\n¬°Ya falta poco!\n\n*Red51 Technology*", "type": "string" }, { "id": "tel3", "name": "telefono_cliente", "value": "={{$json.record.telefono_cliente}}", "type": "string" } ] }, "options": {} }, "id": "27cabae9-1c3a-4d0b-99f7-813c9434c8ed", "name": "Set Msg: Enviado1", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ -656, 896 ], "notes": "ACCI√ìN (Opcional): Personaliza el mensaje para el estado 'Enviado'." }, { "parameters": { "assignments": { "assignments": [ { "id": "msg4", "name": "mensaje", "value": "=¬°Pedido entregado! ‚úÖ\n\nConfirmamos que tu pedido N¬∞ {{$json.record.numero_pedido}} ha sido entregado.\n\nEsperamos que disfrutes de tus nuevos productos. ¬°Gracias por confiar en nosotros y hasta la pr√≥xima!\n\n*Red51 Technology*", "type": "string" }, { "id": "tel4", "name": "telefono_cliente", "value": "={{$json.record.telefono_cliente}}", "type": "string" } ] }, "options": {} }, "id": "767c17dd-cb02-4cf8-91b0-82e433b01886", "name": "Set Msg: Entregado1", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ -656, 1088 ], "notes": "ACCI√ìN (Opcional): Personaliza el mensaje para el estado 'Entregado'." }, { "parameters": { "httpMethod": "POST", "path": "pedidos_red51", "responseMode": "responseNode", "options": {} }, "id": "a286eedf-b94c-4ea1-bc9d-f72a140f7eec", "name": "Webhook Pedidos", "type": "n8n-nodes-base.webhook", "typeVersion": 1, "position": [ -1760, -192 ], "notes": "FLUJO 1: NUEVO PEDIDO\n\nProp√≥sito: Recibir nuevos pedidos desde la tienda, notificar al administrador y enviar una confirmaci√≥n al cliente.\n\nACCI√ìN: Copia la URL de este webhook (Test o Production URL) y p√©gala en la variable de entorno VITE_N8N_WEBHOOK_URL de Vercel." }, { "parameters": { "jsCode": "// Obtiene los datos del pedido que la aplicaci√≥n web envi√≥\nconst webhookData = $input.first().json.body;\n\n// Extrae todos los datos, incluyendo el N√öMERO DE PEDIDO CORRECTO\nconst nombre_cliente = webhookData.nombre_cliente;\nconst telefono_cliente_raw = webhookData.telefono_cliente;\nconst email_cliente = webhookData.email_cliente;\nconst direccion_cliente = webhookData.direccion;\nconst productos_pedido = webhookData.productos;\nconst total_pedido = webhookData.total;\nconst numero_pedido_oficial = webhookData.numero_pedido; // <-- ¬°Aqu√≠ est√° la clave!\n\n// Agregar prefijo 51 para Per√∫\nconst telefono_cliente = '51' + telefono_cliente_raw;\n\nlet detalleProductos = '';\nlet cantidad_items = 0;\n\nproductos_pedido.forEach(item => {\n    // Aseguramos que el nombre del producto se obtenga correctamente\n    const nombreProducto = item.nombre || item.producto;\n    detalleProductos += `‚Ä¢ ${item.cantidad} x ${nombreProducto} (S/ ${item.precio_unitario.toFixed(2)} c/u) = S/ ${item.subtotal.toFixed(2)}\\n`;\n    cantidad_items += item.cantidad;\n});\n\nconst mensaje_admin = `\nüõí *NUEVO PEDIDO - RED51 TECHNOLOGY* üì±\n\nüìã Pedido: *${numero_pedido_oficial}*\n\nüë§ *Cliente:* ${nombre_cliente}\nüìû *Tel√©fono:* ${telefono_cliente}\nüìß *Email:* ${email_cliente || 'No especificado'}\nüìç *Direcci√≥n:* ${direccion_cliente}\n\nüì¶ *DETALLE DEL PEDIDO:*\n${detalleProductos}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüí∞ *TOTAL A PAGAR:* S/ ${total_pedido.toFixed(2)}\nüóìÔ∏è *Fecha:* ${new Date().toLocaleString('es-PE', { timeZone: 'America/Lima' })}\n\n‚ö†Ô∏è *ESPERANDO PAGO DEL CLIENTE*\n\nüí° Para confirmar el pago, responde:\n*confirmar ${numero_pedido_oficial}*\n`;\n\nconst mensaje_cliente = `\n¬°Hola *${nombre_cliente.split(' ')[0]}*! üëã\n\n‚úÖ Tu pedido ha sido recibido exitosamente en *Red51 Technology*.\n\nüìã *N√∫mero de Pedido:* ${numero_pedido_oficial}\n\nüì¶ *Resumen:*\n${detalleProductos}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüí∞ *TOTAL:* S/ ${total_pedido.toFixed(2)}\n\nüìç *Direcci√≥n de entrega:*\n${direccion_cliente}\n\nüí≥ *DATOS PARA TU PAGO:*\n- *Yape/Plin:* 975615244\n- *Monto exacto:* S/ ${total_pedido.toFixed(2)}\n\nüì∏ *IMPORTANTE:* Env√≠a tu comprobante de pago respondiendo a este mensaje.\n\n‚è∞ Confirmaremos tu pago y coordinaremos la entrega inmediatamente.\n\nüì± ¬°Gracias por confiar en Red51 Technology!\n\n_Tecnolog√≠a de Vanguardia_\n`;\n\n// Devolvemos todos los datos originales del pedido, M√ÅS los mensajes formateados\nreturn [{\n    json: {\n        ...webhookData, // Pasamos todos los datos originales\n        telefono_cliente: telefono_cliente, // Pasamos el tel√©fono formateado\n        mensaje_admin: mensaje_admin,\n        mensaje_cliente: mensaje_cliente,\n        // Ya no necesitamos numero_pedido_temp\n    }\n}];" }, "id": "14183a0e-d0e4-49a8-900e-42cff716f29d", "name": "Formatear Mensaje", "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [ -1552, -192 ], "notes": "¬°ACCI√ìN REQUERIDA!\n\nEdita este c√≥digo para personalizar los mensajes.\n\n1.  **`mensaje_admin`**: Cambia el nombre del negocio 'RED51 TECHNOLOGY'.\n2.  **`mensaje_cliente`**: Cambia el nombre del negocio y, MUY IMPORTANTE, actualiza los datos de pago (Yape/Plin, cuentas bancarias, etc.)." }, { "parameters": { "method": "POST", "url": "=https://api.red51.site/message/sendText/chatbot", "authentication": "predefinedCredentialType", "nodeCredentialType": "evolutionApi", "sendHeaders": true, "headerParameters": { "parameters": [ { "name": "Content-Type", "value": "application/json" }, { "name": "apikey", "value": "D55E32A4EB2D-4770-B385-B750BD86D958" } ] }, "sendBody": true, "bodyParameters": { "parameters": [ { "name": "number", "value": "=51905820448" }, { "name": "text", "value": "={{ $json.mensaje_admin }}" } ] }, "options": {} }, "id": "a2238709-2862-4e95-a5ae-1b98faffac66", "name": "Enviar WhatsApp Admin", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.1, "position": [ -1264, -304 ], "notes": "¬°ACCI√ìN REQUERIDA!\n\n1.  En 'Body Parameters', reemplaza '51905820448' con el n√∫mero de WhatsApp del due√±o de la tienda.\n2.  En 'Credential', selecciona tus credenciales para la API de WhatsApp." }, { "parameters": { "method": "POST", "url": "=https://api.red51.site/message/sendText/chatbot", "authentication": "predefinedCredentialType", "nodeCredentialType": "evolutionApi", "sendHeaders": true, "headerParameters": { "parameters": [ { "name": "Content-Type", "value": "application/json" }, { "name": "apikey", "value": "D55E32A4EB2D-4770-B385-B750BD86D958" } ] }, "sendBody": true, "bodyParameters": { "parameters": [ { "name": "number", "value": "={{ $json.telefono_cliente }}" }, { "name": "text", "value": "={{ $json.mensaje_cliente }}" } ] }, "options": {} }, "id": "245de41a-a147-4108-b91a-d41cacc12198", "name": "Confirmaci√≥n al Cliente", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.1, "position": [ -1280, -96 ] }, { "parameters": { "respondWith": "json", "responseBody": "={{ { \"success\": true, \"message\": \"Pedido recibido correctamente. Te contactaremos pronto.\", \"pedido_id\": $now.format('YYYYMMDDHHmmss'), \"total\": $json.total } }}", "options": {} }, "id": "8c95423e-9545-42e2-a4f3-90c79908cdf9", "name": "Responder al Webhook", "type": "n8n-nodes-base.respondToWebhook", "typeVersion": 1, "position": [ -1008, -304 ] }, { "parameters": { "jsCode": "const items = $input.all();\nconst now = new Date();\nconst results = [];\n\nfor (const item of items) {\n  const pedido = item.json;\n  const createdAt = new Date(pedido.created_at);\n  const horasTranscurridas = (now - createdAt) / (1000 * 60 * 60);\n  \n  let tipoRecordatorio = null;\n  let prioridad = 'baja';\n  \n  // Verificar recordatorios ya enviados\n  const recordatoriosEnviados = pedido.recordatorios_enviados || [];\n  \n  // Solo 3 recordatorios: 6h, 24h, 48h (prioriza los m√°s urgentes)\n  if (horasTranscurridas >= 48 && !recordatoriosEnviados.includes('recordatorio_48h')) {\n    tipoRecordatorio = 'recordatorio_48h';\n    prioridad = 'urgente';\n  } else if (horasTranscurridas >= 24 && !recordatoriosEnviados.includes('recordatorio_24h')) {\n    tipoRecordatorio = 'recordatorio_24h';\n    prioridad = 'alta';\n  } else if (horasTranscurridas >= 6 && !recordatoriosEnviados.includes('recordatorio_6h')) {\n    tipoRecordatorio = 'recordatorio_6h';\n    prioridad = 'media';\n  }\n  \n  // Solo incluir si corresponde enviar recordatorio\n  if (tipoRecordatorio) {\n    results.push({\n      json: {\n        ...pedido,\n        tipoRecordatorio,\n        prioridad,\n        horasTranscurridas: Math.floor(horasTranscurridas)\n      }\n    });\n  }\n}\n\nreturn results;" }, "id": "a82aa815-45c1-4a3e-ae92-c9c18d78b49d", "name": "Filtrar por Tiempo", "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [ -1184, 1760 ] }, { "parameters": { "conditions": { "string": [ { "value1": "={{ $json.tipoRecordatorio }}", "value2": "recordatorio_6h" } ] } }, "id": "52e72e41-30a2-4266-a5d7-7eeee7658044", "name": "Es 6h?", "type": "n8n-nodes-base.if", "typeVersion": 1, "position": [ -736, 1568 ] }, { "parameters": { "conditions": { "string": [ { "value1": "={{ $json.tipoRecordatorio }}", "value2": "recordatorio_24h" } ] } }, "id": "0e2429b9-5ad0-41fe-9393-2612b904836a", "name": "Es 24h?", "type": "n8n-nodes-base.if", "typeVersion": 1, "position": [ -736, 1760 ] }, { "parameters": { "conditions": { "string": [ { "value1": "={{ $json.tipoRecordatorio }}", "value2": "recordatorio_48h" } ] } }, "id": "593d9b39-1f77-44b5-96b4-e0b22358d4fb", "name": "Es 48h?", "type": "n8n-nodes-base.if", "typeVersion": 1, "position": [ -736, 1952 ] }, { "parameters": { "assignments": { "assignments": [ { "id": "msg6h", "name": "mensaje", "value": "=Hola {{ $json.nombre_cliente }} üòä\n\nTu pedido *{{$json.numero_pedido}}* est√° esperando por ti.\n\nüéØ *¬øSab√≠as que?*\nTenemos stock limitado y tu pedido est√° reservado por 72 horas.\n\nüí∞ Total: S/ {{$json.total}}\n\nüí≥ Paga f√°cilmente con:\n‚Ä¢ Yape/Plin: 975615244\n\nSi tienes dudas, ¬°escr√≠benos! Estamos para ayudarte.\n\n_Red51 Technology_", "type": "string" }, { "id": "tel6h", "name": "telefono_cliente", "value": "={{$json.telefono_cliente}}", "type": "string" }, { "id": "pedido_id", "name": "pedido_id", "value": "={{$json.id}}", "type": "string" }, { "id": "tipo_rec", "name": "tipo_recordatorio", "value": "recordatorio_6h", "type": "string" } ] }, "options": {} }, "id": "7d8acfca-23d7-4c9e-aba6-48e3ca90003d", "name": "Mensaje 6h (Amigable)", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ -512, 1552 ], "notes": "ACCI√ìN (Opcional): Personaliza el primer recordatorio. Actualiza el nombre del negocio y los datos de pago." }, { "parameters": { "assignments": { "assignments": [ { "id": "msg24h", "name": "mensaje", "value": "={{$json.nombre_cliente.split(' ')[0]}}, no queremos que pierdas tu pedido üôè\n\n‚è∞ *Tu reserva vence en 48 horas*\n\nüì¶ Pedido: {{$json.numero_pedido}}\nüí∞ Total: S/ {{$json.total}}\n\nüéÅ *Beneficio especial:* Si completas tu pago hoy, incluimos env√≠o express GRATIS en Lima.\n\nüí≥ Datos de pago:\n‚Ä¢ Yape/Plin: 975615244\n\n¬øNecesitas ayuda? Estamos disponibles.\n\n_Red51 Technology_", "type": "string" }, { "id": "tel24h", "name": "telefono_cliente", "value": "={{$json.telefono_cliente}}", "type": "string" }, { "id": "pedido_id", "name": "pedido_id", "value": "={{$json.id}}", "type": "string" }, { "id": "tipo_rec", "name": "tipo_recordatorio", "value": "recordatorio_24h", "type": "string" } ] }, "options": {} }, "id": "2d6b1747-aac5-44b5-ad59-230e4cc57f69", "name": "Mensaje 24h (Incentivo)", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ -512, 1744 ], "notes": "ACCI√ìN (Opcional): Personaliza el segundo recordatorio. Actualiza el nombre del negocio y los datos de pago." }, { "parameters": { "rule": { "interval": [ { "field": "cronExpression", "expression": "0 10,16,20 * * *" } ] } }, "id": "07af6a90-4eb3-4dcf-8e42-d9b518814b71", "name": "Programacion (10AM, 4PM, 8PM)1", "type": "n8n-nodes-base.scheduleTrigger", "typeVersion": 1.1, "position": [ -1632, 1760 ], "notes": "FLUJO 3: RECORDATORIOS DE PAGO\n\nProp√≥sito: Enviar recordatorios a clientes que no han pagado su pedido.\n\nACCI√ìN (Opcional): Si quieres cambiar los horarios, edita la 'Cron Expression'. Actualmente se ejecuta a las 10AM, 4PM (16:00) y 8PM (20:00)." }, { "parameters": { "operation": "getAll", "tableId": "pedidos", "matchType": "allFilters", "filters": { "conditions": [ { "keyName": "estado", "condition": "eq", "keyValue": "pendiente_pago" } ] } }, "id": "58f1e5fd-1d1f-4ecd-a57e-32948e9e9203", "name": "Obtener Pedidos Pendientes1", "type": "n8n-nodes-base.supabase", "typeVersion": 1, "position": [ -1408, 1760 ], "notes": "ACCI√ìN: Selecciona tus credenciales de Supabase en la secci√≥n 'Credential'." }, { "parameters": { "jsCode": "const items = $input.all();\nconst results = [];\n\nfunction normalizarTelefono(telefono) {\n  if (!telefono) return null;\n  \n  // Convertir a string y limpiar espacios\n  let numero = String(telefono).trim().replace(/\\s+/g, '');\n  \n  // Remover caracteres especiales (guiones, par√©ntesis, etc)\n  numero = numero.replace(/[^\\d]/g, '');\n  \n  // Casos:\n  // 1. Si empieza con 51 y tiene 11 d√≠gitos -> ya est√° bien\n  if (numero.startsWith('51') && numero.length === 11) {\n    return numero;\n  }\n  \n  // 2. Si tiene 9 d√≠gitos y empieza con 9 -> agregar 51\n  if (numero.length === 9 && numero.startsWith('9')) {\n    return '51' + numero;\n  }\n  \n  // 3. Si tiene 11 d√≠gitos pero NO empieza con 51 -> posible error\n  if (numero.length === 11 && !numero.startsWith('51')) {\n    return numero;\n  }\n  \n  // 4. Si tiene 10 d√≠gitos -> remover el primer 0 y agregar 51\n  if (numero.length === 10 && numero.startsWith('0')) {\n    return '51' + numero.substring(1);\n  }\n  \n  // 5. Cualquier otro caso: intentar agregar 51\n  if (numero.length === 9) {\n    return '51' + numero;\n  }\n  \n  // Si no coincide con ning√∫n patr√≥n, devolver null\n  console.log(`‚ö†Ô∏è N√∫mero no v√°lido: ${telefono}`);\n  return null;\n}\n\nfor (const item of items) {\n  const telefonoOriginal = item.json.telefono_cliente;\n  const telefonoNormalizado = normalizarTelefono(telefonoOriginal);\n  \n  if (telefonoNormalizado) {\n    results.push({\n      json: {\n        ...item.json,\n        telefono_cliente: telefonoNormalizado,\n        telefono_original: telefonoOriginal\n      }\n    });\n  } else {\n    console.log(`‚ùå Pedido ${item.json.numero_pedido} tiene n√∫mero inv√°lido: ${telefonoOriginal}`);\n  }\n}\n\nreturn results;" }, "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [ -960, 1760 ], "id": "8ae803f2-9c43-43d1-a437-dc4818353c71", "name": "Normalizar Telefono1" }, { "parameters": { "assignments": { "assignments": [ { "id": "msg48h", "name": "mensaje", "value": "={{$json.nombre_cliente.split(' ')[0]}}, √∫ltimo recordatorio ‚è∞\n\n*Tu pedido ser√° cancelado en 24 horas*\n\nüì¶ Pedido: {{$json.numero_pedido}}\nüí∞ Total: S/ {{$json.total}}\n\nDespu√©s de ese tiempo:\n‚Ä¢ Se liberar√° la reserva de stock\n‚Ä¢ Tendr√°s que crear un nuevo pedido\n‚Ä¢ Los precios pueden variar\n\nüí≥ Completa tu pago:\n‚Ä¢ Yape/Plin: 975615244\n\nSi decidiste no continuar, est√° bien. Gracias por tu inter√©s ‚ù§Ô∏è\n\n_Red51 Technology_", "type": "string" }, { "id": "tel48h", "name": "telefono_cliente", "value": "={{$json.telefono_cliente}}", "type": "string" }, { "id": "pedido_id", "name": "pedido_id", "value": "={{$json.id}}", "type": "string" }, { "id": "tipo_rec", "name": "tipo_recordatorio", "value": "recordatorio_48h", "type": "string" } ] }, "options": {} }, "id": "0b240188-0ffb-484d-98b3-4138d4c30362", "name": "Mensaje 48h (Ultimo aviso)1", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ -512, 1936 ], "notes": "ACCI√ìN (Opcional): Personaliza el √∫ltimo recordatorio. Actualiza el nombre del negocio y los datos de pago." }, { "parameters": { "jsCode": "const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  // Obtener el array actual desde Supabase\n  let recordatoriosActuales = [];\n  \n  // Si viene de Supabase como string JSON, parsearlo\n  if (typeof item.json.recordatorios_enviados === 'string') {\n    try {\n      recordatoriosActuales = JSON.parse(item.json.recordatorios_enviados);\n    } catch (e) {\n      recordatoriosActuales = [];\n    }\n  } else if (Array.isArray(item.json.recordatorios_enviados)) {\n    recordatoriosActuales = item.json.recordatorios_enviados;\n  }\n  \n  const nuevoRecordatorio = item.json.tipo_recordatorio;\n  \n  // Crear array actualizado\n  const recordatoriosNuevos = [...recordatoriosActuales, nuevoRecordatorio];\n  \n  results.push({\n    json: {\n      pedido_id: item.json.pedido_id,\n      recordatorios_enviados_json: recordatoriosNuevos\n    }\n  });\n}\n\nreturn results;" }, "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [ -64, 1744 ], "id": "7fc9359b-e14c-4875-8262-771ae935d6eb", "name": "Preparar Recordatorio1" }, { "parameters": { "operation": "update", "tableId": "pedidos", "matchType": "allFilters", "filters": { "conditions": [ { "keyName": "numero_pedido", "condition": "eq", "keyValue": "={{ $json.pedido_id }}" } ] }, "fieldsUi": { "fieldValues": [ { "fieldId": "recordatorios_enviados", "fieldValue": "={{ $json.recordatorios_enviados_json }}" } ] } }, "id": "d39bd2c3-67a7-4acd-8ed5-e3f82e7789f1", "name": "Registrar Envio1", "type": "n8n-nodes-base.supabase", "typeVersion": 1, "position": [ 160, 1744 ] }, { "parameters": { "rule": { "interval": [ { "field": "cronExpression", "expression": "0 2 * * *" } ] } }, "id": "7e064805-f526-4562-83d4-5e82608614db", "name": "Ejecutar Diario 2AM", "type": "n8n-nodes-base.scheduleTrigger", "typeVersion": 1.1, "position": [ -1632, 2176 ], "notes": "FLUJO 4: CANCELACI√ìN AUTOM√ÅTICA\n\nProp√≥sito: Cancelar autom√°ticamente los pedidos que tienen m√°s de 72 horas sin ser pagados.\n\nACCI√ìN (Opcional): Cambia la 'Cron Expression' si quieres que se ejecute en otro horario. '0 2 * * *' significa todos los d√≠as a las 2:00 AM." }, { "parameters": { "operation": "getAll", "tableId": "pedidos", "returnAll": true, "matchType": "allFilters", "filters": { "conditions": [ { "keyName": "estado", "condition": "eq", "keyValue": "pendiente_pago" } ] } }, "id": "4c1155c4-def3-474c-85b4-58d2df9bfb48", "name": "Obtener Pedidos Pendientes", "type": "n8n-nodes-base.supabase", "typeVersion": 1, "position": [ -1408, 2176 ], "notes": "ACCI√ìN: Selecciona tus credenciales de Supabase en la secci√≥n 'Credential'." }, { "parameters": { "jsCode": "const items = $input.all();\nconst results = [];\nconst now = new Date();\nconst limiteHoras = 72;\n\nconsole.log('=== AN√ÅLISIS DE PEDIDOS PENDIENTES ===');\nconsole.log(`Fecha actual: ${now.toISOString()}`);\nconsole.log(`L√≠mite configurado: ${limiteHoras} horas\\n`);\n\nitems.forEach((item, index) => {\n  const pedido = item.json;\n  const fechaCreacion = pedido.created_at || pedido.fecha_pedido;\n  \n  if (!fechaCreacion) {\n    console.log(`‚ö†Ô∏è Pedido ${pedido.numero_pedido} sin fecha, omitiendo`);\n    return;\n  }\n  \n  const createdAt = new Date(fechaCreacion);\n  const horasTranscurridas = (now - createdAt) / (1000 * 60 * 60);\n  \n  console.log(`${index + 1}. ${pedido.numero_pedido}`);\n  console.log(`   Cliente: ${pedido.nombre_cliente}`);\n  console.log(`   Creado: ${createdAt.toISOString()}`);\n  console.log(`   Horas transcurridas: ${horasTranscurridas.toFixed(1)}h`);\n  console.log(`   Estado: ${horasTranscurridas > limiteHoras ? 'üî¥ CANCELAR' : '‚úÖ Mantener'}\\n`);\n  \n  if (horasTranscurridas > limiteHoras) {\n    results.push({\n      json: {\n        id: pedido.id,\n        numero_pedido: pedido.numero_pedido,\n        nombre_cliente: pedido.nombre_cliente,\n        telefono_cliente: pedido.telefono_cliente,\n        total: pedido.total,\n        horas_transcurridas: Math.floor(horasTranscurridas),\n        fecha_creacion: fechaCreacion\n      }\n    });\n  }\n});\n\nconsole.log(`=== RESUMEN ===`);\nconsole.log(`Total analizado: ${items.length}`);\nconsole.log(`Para cancelar: ${results.length}`);\nconsole.log(`Mantener: ${items.length - results.length}`);\n\nif (results.length > 0) {\n  console.log(`\\nüî¥ Pedidos que ser√°n cancelados:`);\n  results.forEach(r => {\n    console.log(`   - ${r.json.numero_pedido} (${r.json.horas_transcurridas}h)`);\n  });\n}\n\nreturn results;" }, "id": "b9e2603e-908a-46ba-9ff5-0b1c3b3ef59e", "name": "Filtrar Pedidos +72h", "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [ -1184, 2176 ], "notes": "ACCI√ìN (Opcional): Para cambiar el tiempo de cancelaci√≥n, edita el valor de la variable `limiteHoras` en la l√≠nea 3 de este c√≥digo. Actualmente est√° en 72." }, { "parameters": { "operation": "update", "tableId": "pedidos", "matchType": "allFilters", "filters": { "conditions": [ { "keyName": "id", "condition": "eq", "keyValue": "={{ $json.id }}" } ] }, "fieldsUi": { "fieldValues": [ { "fieldId": "estado", "fieldValue": "cancelado" } ] } }, "id": "cd95824e-07ae-4ccc-857b-447a4e5cdefd", "name": "Actualizar Estado a Cancelado", "type": "n8n-nodes-base.supabase", "typeVersion": 1, "position": [ -960, 2176 ] }, { "parameters": { "jsCode": "const items = $input.all();\nconst results = [];\n\nfunction normalizarTelefono(telefono) {\n  if (!telefono) return null;\n  \n  let numero = String(telefono).trim().replace(/\\s+/g, '');\n  numero = numero.replace(/[^\\d]/g, '');\n  \n  if (numero.startsWith('51') && numero.length === 11) {\n    return numero;\n  }\n  \n  if (numero.length === 9 && numero.startsWith('9')) {\n    return '51' + numero;\n  }\n  \n  if (numero.length === 10 && numero.startsWith('0')) {\n    return '51' + numero.substring(1);\n  }\n  \n  if (numero.length === 9) {\n    return '51' + numero;\n  }\n  \n  return null;\n}\n\nfor (const item of items) {\n  const telefonoNormalizado = normalizarTelefono(item.json.telefono_cliente);\n  \n  if (telefonoNormalizado) {\n    results.push({\n      json: {\n        ...item.json,\n        telefono_cliente: telefonoNormalizado\n      }\n    });\n  }\n}\n\nreturn results;" }, "id": "3ebb8d80-ddf9-4867-b06e-a370682bf0c0", "name": "Normalizar Tel√©fono", "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [ -736, 2176 ] }, { "parameters": { "assignments": { "assignments": [ { "id": "msg-cancel", "name": "mensaje", "value": "=Hola {{$json.nombre_cliente.split(' ')[0]}} üëã\n\nTe informamos que tu pedido {{$json.numero_pedido}} , ha sido cancelado autom√°ticamente.\n\n‚ùå *Motivo:* Super√≥ el tiempo m√°ximo de reserva (72 horas)\n\nüõí ¬øA√∫n te interesa tu pedido?\nPuedes realizar uno nuevo f√°cilmente desde nuestra web üëâ https://red-51.vercel.app/\n\nEstamos aqu√≠ para ayudarte con cualquier solicitud o consulta que tengas. üí¨\n\nGracias por tu comprensi√≥n ‚ù§Ô∏è\n\n_Red51 Technology_", "type": "string" }, { "id": "tel-cancel", "name": "telefono_cliente", "value": "={{$json.telefono_cliente}}", "type": "string" }, { "id": "pedido-cancel", "name": "numero_pedido", "value": "={{$json.numero_pedido}}", "type": "string" } ] }, "options": {} }, "id": "b44b4c86-8e25-4296-8593-e5c3b85450c3", "name": "Preparar Mensaje de Cancelaci√≥n", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ -512, 2176 ], "notes": "ACCI√ìN (Opcional): Personaliza el mensaje de cancelaci√≥n. Es muy importante que actualices la URL de la tienda al final del mensaje." }, { "parameters": { "method": "POST", "url": "=https://api.red51.site/message/sendText/chatbot", "authentication": "predefinedCredentialType", "nodeCredentialType": "evolutionApi", "sendHeaders": true, "headerParameters": { "parameters": [ { "name": "Content-Type", "value": "application/json" }, { "name": "apikey", "value": "D55E32A4EB2D-4770-B385-B750BD86D958" } ] }, "sendBody": true, "bodyParameters": { "parameters": [ { "name": "number", "value": "={{ $json.telefono_cliente }}" }, { "name": "text", "value": "={{ $json.mensaje }}" } ] }, "options": {} }, "id": "257ee92f-6670-4871-b09d-57f909ba36ce", "name": "Notificar Cancelaci√≥n por WhatsApp", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.1, "position": [ -288, 2176 ] }, { "parameters": { "method": "POST", "url": "=https://api.red51.site/message/sendText/chatbot", "authentication": "predefinedCredentialType", "nodeCredentialType": "evolutionApi", "sendHeaders": true, "headerParameters": { "parameters": [ { "name": "Content-Type", "value": "application/json" }, { "name": "apikey", "value": "D55E32A4EB2D-4770-B385-B750BD86D958" } ] }, "sendBody": true, "bodyParameters": { "parameters": [ { "name": "number", "value": "={{ $json.telefono_cliente }}" }, { "name": "text", "value": "={{ $json.mensaje }}" } ] }, "options": {} }, "id": "42586762-22a7-486e-bd9f-e143ccd45b2e", "name": "Enviar WhatsApp al Cliente1", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.1, "position": [ -288, 1744 ] } ], "connections": { "Formatear Tel√©fono": { "main": [ [ { "node": "IF Estado Cambi√≥1", "type": "main", "index": 0 } ] ] }, "Webhook - Recibir desde Supabase1": { "main": [ [ { "node": "Formatear Tel√©fono", "type": "main", "index": 0 } ] ] }, "IF Estado Cambi√≥1": { "main": [ [ { "node": "Switch por Estado1", "type": "main", "index": 0 } ] ] }, "Switch por Estado1": { "main": [ [ { "node": "Set Msg: Pago Confirmado1", "type": "main", "index": 0 } ], [ { "node": "Set Msg: En Preparaci√≥n1", "type": "main", "index": 0 } ], [ { "node": "Set Msg: Enviado1", "type": "main", "index": 0 } ], [ { "node": "Set Msg: Entregado1", "type": "main", "index": 0 } ] ] }, "Set Msg: Pago Confirmado1": { "main": [ [ { "node": "Enviar WhatsApp al Cliente", "type": "main", "index": 0 } ] ] }, "Set Msg: En Preparaci√≥n1": { "main": [ [ { "node": "Enviar WhatsApp al Cliente", "type": "main", "index": 0 } ] ] }, "Set Msg: Enviado1": { "main": [ [ { "node": "Enviar WhatsApp al Cliente", "type": "main", "index": 0 } ] ] }, "Set Msg: Entregado1": { "main": [ [ { "node": "Enviar WhatsApp al Cliente", "type": "main", "index": 0 } ] ] }, "Webhook Pedidos": { "main": [ [ { "node": "Formatear Mensaje", "type": "main", "index": 0 } ] ] }, "Formatear Mensaje": { "main": [ [ { "node": "Enviar WhatsApp Admin", "type": "main", "index": 0 }, { "node": "Confirmaci√≥n al Cliente", "type": "main", "index": 0 } ] ] }, "Enviar WhatsApp Admin": { "main": [ [ { "node": "Responder al Webhook", "type": "main", "index": 0 } ] ] }, "Filtrar por Tiempo": { "main": [ [ { "node": "Normalizar Telefono1", "type": "main", "index": 0 } ] ] }, "Es 6h?": { "main": [ [ { "node": "Mensaje 6h (Amigable)", "type": "main", "index": 0 } ] ] }, "Es 24h?": { "main": [ [ { "node": "Mensaje 24h (Incentivo)", "type": "main", "index": 0 } ] ] }, "Es 48h?": { "main": [ [ { "node": "Mensaje 48h (Ultimo aviso)1", "type": "main", "index": 0 } ] ] }, "Mensaje 6h (Amigable)": { "main": [ [ { "node": "Enviar WhatsApp al Cliente1", "type": "main", "index": 0 } ] ] }, "Mensaje 24h (Incentivo)": { "main": [ [ { "node": "Enviar WhatsApp al Cliente1", "type": "main", "index": 0 } ] ] }, "Programacion (10AM, 4PM, 8PM)1": { "main": [ [ { "node": "Obtener Pedidos Pendientes1", "type": "main", "index": 0 } ] ] }, "Obtener Pedidos Pendientes1": { "main": [ [ { "node": "Filtrar por Tiempo", "type": "main", "index": 0 } ] ] }, "Normalizar Telefono1": { "main": [ [ { "node": "Es 6h?", "type": "main", "index": 0 }, { "node": "Es 24h?", "type": "main", "index": 0 }, { "node": "Es 48h?", "type": "main", "index": 0 } ] ] }, "Mensaje 48h (Ultimo aviso)1": { "main": [ [ { "node": "Enviar WhatsApp al Cliente1", "type": "main", "index": 0 } ] ] }, "Preparar Recordatorio1": { "main": [ [ { "node": "Registrar Envio1", "type": "main", "index": 0 } ] ] }, "Ejecutar Diario 2AM": { "main": [ [ { "node": "Obtener Pedidos Pendientes", "type": "main", "index": 0 } ] ] }, "Obtener Pedidos Pendientes": { "main": [ [ { "node": "Filtrar Pedidos +72h", "type": "main", "index": 0 } ] ] }, "Filtrar Pedidos +72h": { "main": [ [ { "node": "Actualizar Estado a Cancelado", "type": "main", "index": 0 } ] ] }, "Actualizar Estado a Cancelado": { "main": [ [ { "node": "Normalizar Tel√©fono", "type": "main", "index": 0 } ] ] }, "Normalizar Tel√©fono": { "main": [ [ { "node": "Preparar Mensaje de Cancelaci√≥n", "type": "main", "index": 0 } ] ] }, "Preparar Mensaje de Cancelaci√≥n": { "main": [ [ { "node": "Notificar Cancelaci√≥n por WhatsApp", "type": "main", "index": 0 } ] ] }, "Enviar WhatsApp al Cliente1": { "main": [ [ { "node": "Preparar Recordatorio1", "type": "main", "index": 0 } ] ] } } };

    function showDashboard() {
        currentProjectId = null;
        dashboardView.style.display = 'block';
        projectView.style.display = 'none';
        renderDashboard();
    }

    function showProjectView(projectId) {
        currentProjectId = projectId;
        dashboardView.style.display = 'none';
        projectView.style.display = 'block';
        showProjectTab('checklist'); // Default to checklist tab
        renderProjectView();
    }
    
    function showProjectTab(tabName) {
        document.getElementById('checklistTabContent').style.display = tabName === 'checklist' ? 'block' : 'none';
        document.getElementById('n8nGuideTabContent').style.display = tabName === 'n8n' ? 'block' : 'none';
        
        document.querySelectorAll('.project-tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.project-tab-btn[onclick="showProjectTab('${tabName}')"]`).classList.add('active');
    }

    function loadProjects() {
        const stored = localStorage.getItem('saas_projects_v7');
        projects = stored ? JSON.parse(stored) : [];
        showDashboard();
    }

    function saveProjects() {
        localStorage.setItem('saas_projects_v7', JSON.stringify(projects));
    }

    function calculateProgress(project) {
        const completed = Object.values(project.checklist).filter(Boolean).length;
        return (completed / TOTAL_TASKS) * 100;
    }
    
    function copySqlScript(button, elementId) {
        const isN8n = elementId === 'n8nMasterWorkflow';
        const textToCopy = isN8n ? JSON.stringify(n8nMasterWorkflowJSON, null, 2) : sqlScriptContent;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = button.textContent;
            button.textContent = '¬°Copiado!';
            button.style.backgroundColor = 'var(--success)';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = '';
            }, 2000);
        }).catch(err => {
            console.error('Error al copiar:', err);
            alert('No se pudo copiar el contenido.');
        });
    }

    function renderDashboard() {
        projectList.innerHTML = '';
        if (projects.length === 0) {
            projectList.innerHTML = '<p>A√∫n no has agregado ning√∫n proyecto. Haz clic en el bot√≥n de arriba para empezar.</p>';
            return;
        }
        projects.forEach(project => {
            const progress = calculateProgress(project);
            const projectCard = document.createElement('div');
            projectCard.className = 'project-card';
            projectCard.onclick = () => showProjectView(project.id);
            projectCard.innerHTML = `
                <div class="project-card-header">
                    <h3>${project.name}</h3>
                    <p>${project.contact}</p>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${progress}%;"></div>
                </div>
                <div class="project-card-footer">
                    <span>Progreso: ${Math.round(progress)}%</span>
                    <span>${new Date(project.createdAt).toLocaleDateString()}</span>
                </div>
            `;
            projectList.appendChild(projectCard);
        });
    }

    function renderProjectView() {
        const project = projects.find(p => p.id === currentProjectId);
        if (!project) { showDashboard(); return; }
        document.getElementById('projectNameHeader').textContent = `Proyecto: ${project.name}`;
        for (const key in project.fields) { if(document.getElementById(`field_${key}`)) document.getElementById(`field_${key}`).value = project.fields[key] || ''; }
        for (const key in project.checklist) { if(document.getElementById(key)) document.getElementById(key).checked = project.checklist[key]; }
        updateMainTasks();
    }
    
    function saveCurrentProjectData() {
        if (!currentProjectId) return;
        const project = projects.find(p => p.id === currentProjectId);
        if (!project) return;
        for (const key in project.fields) { if(document.getElementById(`field_${key}`)) project.fields[key] = document.getElementById(`field_${key}`).value; }
        for (const key in project.checklist) { if(document.getElementById(key)) project.checklist[key] = document.getElementById(key).checked; }
        updateMainTasks();
        saveProjects();
    }
    
    function updateMainTasks() {
        const project = projects.find(p => p.id === currentProjectId);
        if (!project) return;
        const chk = project.checklist;
        document.getElementById('task1').checked = chk.task1_1 && chk.task1_2 && chk.task1_3;
        document.getElementById('task2').checked = chk.task2_1 && chk.task2_2;
        document.getElementById('task3').checked = chk.task3_1 && chk.task3_2 && chk.task3_3;
    }

    function openProjectModal() {
        projectModal.innerHTML = `<div class="modal-content">
            <div class="modal-header">
                <h2>Crear Nuevo Proyecto</h2>
                <span class="close-btn" onclick="closeProjectModal()">&times;</span>
            </div>
            <form id="projectForm" onsubmit="handleFormSubmit(event)">
                <div class="form-group">
                    <label for="projectName">Nombre del Negocio</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label for="projectContact">Email de Contacto (Admin)</label>
                    <input type="email" id="projectContact" required>
                </div>
                <button type="submit" class="btn">Empezar Onboarding</button>
            </form>
        </div>`;
        projectModal.style.display = 'block';
    }

    function closeProjectModal() { projectModal.style.display = 'none'; }

    function handleFormSubmit(event) {
        event.preventDefault();
        const newProject = {
            id: `proj_${Date.now()}`,
            name: document.getElementById('projectName').value,
            contact: document.getElementById('projectContact').value,
            createdAt: new Date().toISOString(),
            fields: {
                supabaseProjectName: '', supabaseUrl: '', supabaseKey: '',
                n8nUrl: '', n8nStatusUrl: '', vercelUrl: ''
            },
            checklist: {
                task1_1: false, task1_2: false, task1_3: false,
                task2_1: false, task2_2: false,
                task3_1: false, task3_2: false, task3_3: false
            }
        };
        projects.push(newProject);
        saveProjects();
        closeProjectModal();
        showProjectView(newProject.id);
    }

    function deleteCurrentProject() {
        if (!currentProjectId) return;
        const project = projects.find(p => p.id === currentProjectId);
        if (confirm(`¬øEst√°s seguro de que quieres eliminar el proyecto "${project.name}"? Esta acci√≥n no se puede deshacer.`)) {
            projects = projects.filter(p => p.id !== currentProjectId);
            saveProjects();
            showDashboard();
        }
    }

    window.onload = function() {
        document.getElementById('sqlScript').textContent = sqlScriptContent;
        document.getElementById('n8nMasterWorkflow').textContent = JSON.stringify(n8nMasterWorkflowJSON, null, 2);
        loadProjects();
        document.getElementById('onboardingChecklist').addEventListener('input', (event) => {
            if (event.target.matches('input[type="checkbox"], input[type="url"], input[type="text"], textarea')) {
                saveCurrentProjectData();
            }
        });
    };

    window.onclick = function(event) { if (event.target == projectModal) { closeProjectModal(); } }
</script>
</body>
</html>
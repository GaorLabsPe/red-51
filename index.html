<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red51 Technology - Tienda Online</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #7B5C7E;
            --secondary: #1B9AA8;
            --accent: #168B97;
            --dark: #1a1a2e;
            --light: #f5f5f5;
            --white: #FFFFFF;
            --text-dark: #1a1a1a;
            --success: #1B9AA8;
            --danger: #e94560;
            --shadow: 0 2px 20px rgba(0,0,0,0.08);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light);
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .header {
            background: var(--white);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-dark);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            cursor: pointer;
        }
        
        .logo-red {
            color: var(--secondary);
        }
        
        .logo-number {
            color: var(--primary);
        }
        
        .logo-subtitle {
            font-size: 0.5em;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-dark);
            display: block;
            margin-top: -8px;
        }
        
        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .nav-btn {
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .nav-btn:hover {
            color: var(--secondary);
        }
        
        .cart-btn {
            position: relative;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(27, 154, 168, 0.3);
        }
        
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: var(--white);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .hero {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 5rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            font-weight: 800;
        }
        
        .hero p {
            font-size: 1.3rem;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }
        
        .category-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .filter-btn {
            padding: 0.75rem 1.5rem;
            background: var(--white);
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
            border-color: var(--secondary);
        }
        
        .products-section {
            margin-bottom: 4rem;
        }
        
        .section-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--primary);
            font-weight: 700;
            text-align: center;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .product-card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 30px rgba(27, 154, 168, 0.2);
        }
        
        .product-image {
            width: 100%;
            height: 250px;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(233, 69, 96, 0.95);
            color: var(--white);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .product-info {
            padding: 1.5rem;
        }
        
        .product-category {
            color: var(--secondary);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .product-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }
        
        .product-brand {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .product-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .product-price {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .add-to-cart-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-to-cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(27, 154, 168, 0.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--white);
            max-width: 800px;
            margin: 2rem auto;
            border-radius: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 2rem;
            border-bottom: 2px solid var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }
        
        .modal-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-dark);
            line-height: 1;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .cart-item {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--light);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .cart-item-icon {
            font-size: 3rem;
            flex-shrink: 0;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-dark);
            margin-bottom: 0.3rem;
        }
        
        .cart-item-brand {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }
        
        .cart-item-price {
            color: #666;
            font-size: 0.95rem;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .qty-btn {
            background: var(--white);
            border: 2px solid var(--primary);
            color: var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
        }
        
        .qty-btn:hover {
            background: var(--primary);
            color: var(--white);
        }
        
        .qty-display {
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 30px;
            text-align: center;
        }
        
        .remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            margin-left: auto;
        }
        
        .cart-total {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cart-total-label {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .cart-total-amount {
            font-size: 2rem;
            font-weight: 800;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--light);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 1.2rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(27, 154, 168, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--white);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--white);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .empty-cart {
            text-align: center;
            padding: 3rem 2rem;
            color: #999;
        }
        
        .empty-cart-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .success-icon {
            font-size: 5rem;
            color: var(--success);
            margin-bottom: 1rem;
        }
        
        .success-message h3 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .success-message p {
            color: #666;
            margin-bottom: 2rem;
        }
        
        .admin-section {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-import {
            background: #10b981;
            color: var(--white);
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .btn-import:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-export {
            background: #6366f1;
            color: var(--white);
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .btn-export:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }

        .image-preview {
            width: 100%;
            max-width: 200px;
            height: 200px;
            border: 2px solid var(--light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            margin-top: 0.5rem;
            overflow: hidden;
            position: relative;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-preview-text {
            font-size: 4rem;
        }

        .upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--light);
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            transition: width 0.3s;
        }

        .btn-upload {
            background: #10b981;
            color: var(--white);
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            margin-top: 0.5rem;
        }

        .btn-upload:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-upload:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .products-table th,
        .products-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--light);
        }
        
        .products-table th {
            background: var(--light);
            font-weight: 700;
            color: var(--primary);
        }
        
        .products-table tr:hover {
            background: var(--light);
        }
        
        .table-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-edit {
            background: var(--secondary);
            color: var(--white);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .status-select {
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: #fff;
            font-weight: 600;
            font-family: inherit;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        
        .footer {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
            text-align: center;
            padding: 2.5rem 2rem;
            margin-top: 4rem;
        }
        
        .footer-logo {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        
        .login-section {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-info {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--secondary);
        }
        
        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid var(--light);
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #999;
            position: relative;
            top: 2px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .order-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .order-details-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
        }

        .order-details-card h4 {
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 0.5rem;
        }

        .order-details-card p {
            margin-bottom: 0.5rem;
            color: #333;
        }
        .order-details-card p strong {
            color: #555;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .modal-content {
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                width: 100%;
            }
            
            .logo {
                font-size: 1.5rem;
            }
            
            .products-table {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <div>
                <div class="logo" onclick="mostrarTienda()">
                    <span class="logo-red">Red</span><span class="logo-number">51</span>
                </div>
                <span class="logo-subtitle">TECHNOLOGY</span>
            </div>
            <div class="nav-links">
                <button class="nav-btn" onclick="mostrarTienda()" id="btnTienda">Tienda</button>
                <button class="nav-btn" onclick="mostrarAdmin()" id="btnAdmin">Admin</button>
                <button class="cart-btn" onclick="abrirCarrito()">
                    Carrito
                    <span class="cart-count" id="cartCount">0</span>
                </button>
            </div>
        </nav>
    </header>

    <div id="tiendaView">
        <section class="hero">
            <div>
                <h1>Tecnologia de Vanguardia</h1>
                <p>Los mejores productos de tecnologia y electronica con las marcas mas reconocidas del mercado</p>
            </div>
        </section>

        <main class="container">
            <section class="products-section">
                <div class="category-filter" id="categoryFilter"></div>
                <h2 class="section-title">Nuestros Productos</h2>
                <div class="products-grid" id="productsGrid"></div>
                <div id="loadingProducts" class="loading" style="display:none;">Cargando productos...</div>
            </section>
        </main>
    </div>

    <div id="adminView" style="display:none;">
        <main class="container">
            <div id="loginSection" class="login-section">
                <h2 style="margin-bottom: 1rem; color: var(--primary);">Acceso Administrador</h2>
                <div class="auth-info">
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                        Para acceder al panel de administracion, primero debes crear un usuario en tu proyecto de Supabase:
                    </p>
                    <ol style="color: #666; font-size: 0.9rem; margin-left: 1.5rem;">
                        <li>Ve a tu proyecto Supabase Dashboard</li>
                        <li>Menu: Authentication → Users</li>
                        <li>Click "Add user" → "Create new user"</li>
                        <li>Ingresa email y contraseña</li>
                        <li>Confirma el email del usuario</li>
                        <li>Vuelve aqui e inicia sesion</li>
                    </ol>
                </div>
                <form id="loginForm" onsubmit="iniciarSesion(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="emailLogin" required placeholder="admin@red51.com">
                    </div>
                    <div class="form-group">
                        <label>Contraseña</label>
                        <input type="password" id="passwordLogin" required>
                    </div>
                    <button type="submit" class="btn-primary">Iniciar Sesion</button>
                    <div id="loginError" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; background: #f8d7da; color: #721c24;"></div>
                </form>
            </div>

            <div id="adminPanel" style="display:none;">
                <div class="admin-section">
                    <div class="admin-header">
                        <h2>Panel de Administracion</h2>
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <span id="adminEmail" style="color: #666; font-size: 0.9rem;"></span>
                             <button class="btn-danger" onclick="cerrarSesion()">Cerrar Sesion</button>
                        </div>
                    </div>

                    <div class="admin-tabs">
                        <button id="tabProductos" class="tab-btn active" onclick="mostrarVistaAdmin('productos')">Productos</button>
                        <button id="tabPedidos" class="tab-btn" onclick="mostrarVistaAdmin('pedidos')">Pedidos</button>
                    </div>

                    <div id="adminProductosView">
                        <div class="admin-actions" style="margin-bottom: 2rem;">
                            <button class="btn-export" onclick="descargarPlantilla()">📥 Descargar Plantilla CSV</button>
                            <button class="btn-import" onclick="document.getElementById('importFile').click()">📤 Importar CSV</button>
                            <input type="file" id="importFile" accept=".csv" style="display:none;" onchange="importarProductos(event)">
                            <button class="btn-secondary" onclick="abrirModalProducto()">+ Agregar Producto</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>Imagen</th>
                                        <th>Icon</th>
                                        <th>Nombre</th>
                                        <th>Marca</th>
                                        <th>Categoria</th>
                                        <th>Precio</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="adminProductsTable"></tbody>
                            </table>
                        </div>
                        <div id="loadingAdmin" class="loading" style="display:none;">Cargando...</div>
                    </div>

                    <div id="adminPedidosView" style="display:none;">
                        <div style="overflow-x: auto;">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Telefono</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="adminOrdersTable"></tbody>
                            </table>
                        </div>
                        <div id="loadingAdminPedidos" class="loading" style="display:none;">Cargando pedidos...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tu Carrito</h2>
                <button class="close-btn" onclick="cerrarCarrito()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cartContent"></div>
                <div id="successMessage" class="success-message">
                    <div class="success-icon">✓</div>
                    <h3>Pedido Realizado con Exito</h3>
                    <p>Hemos recibido tu pedido. Te contactaremos pronto por WhatsApp para coordinar el pago y la entrega.</p>
                    <button class="btn-primary" onclick="cerrarYLimpiar()">Continuar Comprando</button>
                </div>
            </div>
        </div>
    </div>

    <div id="productoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productoModalTitle">Agregar Producto</h2>
                <button class="close-btn" onclick="cerrarModalProducto()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productoForm" onsubmit="guardarProducto(event)">
                    <input type="hidden" id="productoId">
                    <div class="form-group">
                        <label>Nombre del Producto</label>
                        <input type="text" id="productoNombre" required>
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" id="productoMarca" required>
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="productoCategoria" required>
                            <option value="moviles">Smartphones & Tablets</option>
                            <option value="audio">Audio</option>
                            <option value="hogar">Hogar Inteligente</option>
                            <option value="computacion">Computacion</option>
                            <option value="entretenimiento">Entretenimiento</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descripcion</label>
                        <textarea id="productoDescripcion" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Precio (S/)</label>
                        <input type="number" id="productoPrecio" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Imagen del Producto</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button type="button" class="btn-upload" onclick="document.getElementById('imageFile').click()">
                                📤 Subir Imagen
                            </button>
                            <input type="file" id="imageFile" accept="image/*" style="display:none;" onchange="subirImagenCloudinary(event)">
                            <input type="url" id="productoImagen" placeholder="O pega URL de imagen" style="flex: 1;" oninput="previewImagen()">
                        </div>
                        <div class="form-hint">Sube una imagen desde tu dispositivo o pega una URL externa</div>
                        <div class="image-preview" id="imagePreview">
                            <span class="image-preview-text">🖼️</span>
                            <div class="upload-progress" id="uploadProgress" style="display: none;">
                                <div class="upload-progress-bar" id="uploadProgressBar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Icono (Emoji) - Se usa si no hay imagen</label>
                        <input type="text" id="productoIcon" maxlength="2" placeholder="📱">
                    </div>
                    <div class="form-group">
                        <label>Etiqueta (Opcional)</label>
                        <input type="text" id="productoBadge" placeholder="Nuevo, Popular, Oferta...">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productoActivo" checked> Producto activo
                        </label>
                    </div>
                    <button type="submit" class="btn-primary">Guardar Producto</button>
                </form>
            </div>
        </div>
    </div>

    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="orderDetailsTitle">Detalles del Pedido</h2>
                <button class="close-btn" onclick="cerrarDetallesPedido()">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailsContent"></div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-logo">Red51 TECHNOLOGY</div>
        <p>2025 Red51 Technology. Todos los derechos reservados.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://zejzrujrspeoszpfbjce.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplanpydWpyc3Blb3N6cGZiamNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MDMyNDMsImV4cCI6MjA3NTE3OTI0M30.UAi4jQ0BH1hphW7OEh4JWP4hdVJ4CmvX6x4CyP2ak-U';
        const N8N_WEBHOOK_URL = 'https://webhook.red51.site/webhook/pedidos_red51';
        const CLOUDINARY_CLOUD_NAME = 'dvj68er8s';
        const CLOUDINARY_UPLOAD_PRESET = 'red51_productos';
        
        let carrito = [];
        let supabaseClient = null;
        let categoriaActual = 'todos';
        let productos = [];
        let usuarioActual = null;

        function inicializarSupabase() {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            verificarSesion();
        }

        async function verificarSesion() {
            if (!supabaseClient) return;
            
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                usuarioActual = session.user;
                mostrarPanelAdmin();
            }
        }

        async function iniciarSesion(event) {
            event.preventDefault();
            
            const email = document.getElementById('emailLogin').value;
            const password = document.getElementById('passwordLogin').value;
            const errorDiv = document.getElementById('loginError');
            
            errorDiv.style.display = 'none';
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                usuarioActual = data.user;
                mostrarPanelAdmin();
                
            } catch (error) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error al iniciar sesion: ' + error.message;
            }
        }

        function mostrarPanelAdmin() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminEmail').textContent = usuarioActual.email;
            cargarProductosAdmin();
            cargarPedidosAdmin();
        }

        async function cerrarSesion() {
            await supabaseClient.auth.signOut();
            usuarioActual = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            mostrarTienda();
        }

        function mostrarTienda() {
            document.getElementById('tiendaView').style.display = 'block';
            document.getElementById('adminView').style.display = 'none';
        }

        function mostrarAdmin() {
            document.getElementById('tiendaView').style.display = 'none';
            document.getElementById('adminView').style.display = 'block';
            
            if (usuarioActual) {
                mostrarPanelAdmin();
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        }

        function mostrarVistaAdmin(vista) {
            document.getElementById('adminProductosView').style.display = vista === 'productos' ? 'block' : 'none';
            document.getElementById('adminPedidosView').style.display = vista === 'pedidos' ? 'block' : 'none';
            
            document.getElementById('tabProductos').classList.toggle('active', vista === 'productos');
            document.getElementById('tabPedidos').classList.toggle('active', vista === 'pedidos');
        }

        async function cargarProductos() {
            if (!supabaseClient) {
                console.error('Supabase no inicializado');
                document.getElementById('productsGrid').innerHTML = 
                    '<div class="empty-cart"><p>Error: Supabase no esta inicializado. Recarga la pagina.</p></div>';
                return;
            }

            document.getElementById('loadingProducts').style.display = 'block';

            try {
                console.log('Intentando cargar productos...');
                
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');

                console.log('Respuesta de Supabase:', { data, error });

                if (error) {
                    console.error('Error de Supabase:', error);
                    throw error;
                }

                if (!data || data.length === 0) {
                    console.warn('No se encontraron productos activos');
                    document.getElementById('productsGrid').innerHTML = 
                        '<div class="empty-cart"><p>No hay productos disponibles. Ve al panel Admin para agregar productos.</p></div>';
                    return;
                }

                productos = data;
                console.log('Productos cargados:', productos.length);
                renderizarCategorias();
                renderizarProductos();

            } catch (error) {
                console.error('Error completo:', error);
                document.getElementById('productsGrid').innerHTML = 
                    `<div class="empty-cart">
                        <p>Error al cargar productos: ${error.message}</p>
                        <p style="font-size: 0.9rem; color: #666;">Verifica la consola del navegador para mas detalles.</p>
                    </div>`;
            } finally {
                document.getElementById('loadingProducts').style.display = 'none';
            }
        }

        function renderizarCategorias() {
            if (productos.length === 0) {
                document.getElementById('categoryFilter').innerHTML = '';
                return;
            }
            
            const categorias = ['todos', ...new Set(productos.map(p => p.categoria))];
            const filterContainer = document.getElementById('categoryFilter');
            
            filterContainer.innerHTML = categorias.map(cat => `
                <button class="filter-btn ${cat === categoriaActual ? 'active' : ''}" 
                        onclick="filtrarCategoria('${cat}')">
                    ${getCategoriaName(cat)}
                </button>
            `).join('');
        }

        function filtrarCategoria(categoria) {
            categoriaActual = categoria;
            renderizarCategorias();
            renderizarProductos();
        }

        function renderizarProductos() {
            const grid = document.getElementById('productsGrid');
            const productosFiltrados = categoriaActual === 'todos' 
                ? productos 
                : productos.filter(p => p.categoria === categoriaActual);
            
            if (productosFiltrados.length === 0) {
                grid.innerHTML = '<div class="empty-cart"><p>No hay productos en esta categoria.</p></div>';
                return;
            }

            grid.innerHTML = productosFiltrados.map(producto => `
                <div class="product-card">
                    <div class="product-image">
                        ${producto.imagen_url 
                            ? `<img src="${optimizarImagenUrl(producto.imagen_url)}" alt="${producto.nombre}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                               <span style="display:none">${producto.icon || '📦'}</span>`
                            : `<span>${producto.icon || '📦'}</span>`
                        }
                        ${producto.badge ? `<span class="product-badge">${producto.badge}</span>` : ''}
                    </div>
                    <div class="product-info">
                        <div class="product-category">${getCategoriaName(producto.categoria)}</div>
                        <h3 class="product-name">${producto.nombre}</h3>
                        <div class="product-brand">${producto.marca}</div>
                        <p class="product-description">${producto.descripcion}</p>
                        <div class="product-price">S/ ${parseFloat(producto.precio).toFixed(2)}</div>
                        <button class="add-to-cart-btn" onclick="agregarAlCarrito(${producto.id})">
                            Agregar al Carrito
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getCategoriaName(categoria) {
            const nombres = {
                'todos': 'Todos',
                'moviles': 'Smartphones & Tablets',
                'audio': 'Audio',
                'hogar': 'Hogar Inteligente',
                'computacion': 'Computacion',
                'entretenimiento': 'Entretenimiento'
            };
            return nombres[categoria] || categoria;
        }

        function agregarAlCarrito(productoId) {
            const producto = productos.find(p => p.id === productoId);
            const itemExistente = carrito.find(item => item.id === productoId);
            
            if (itemExistente) {
                itemExistente.cantidad++;
            } else {
                carrito.push({ ...producto, cantidad: 1 });
            }
            
            actualizarContadorCarrito();
            mostrarNotificacion('Producto agregado al carrito');
        }

        function actualizarContadorCarrito() {
            const total = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            document.getElementById('cartCount').textContent = total;
        }

        function abrirCarrito() {
            document.getElementById('cartModal').style.display = 'block';
            renderizarCarrito();
        }

        function cerrarCarrito() {
            document.getElementById('cartModal').style.display = 'none';
        }

        function renderizarCarrito() {
            const content = document.getElementById('cartContent');
            document.getElementById('successMessage').style.display = 'none';
            content.style.display = 'block';
            
            if (carrito.length === 0) {
                content.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-icon">🛒</div>
                        <p>Tu carrito esta vacio</p>
                    </div>
                `;
                return;
            }
            
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            
            content.innerHTML = `
                ${carrito.map((item, index) => `
                    <div class="cart-item">
                        <div class="cart-item-icon">${item.icon || '📦'}</div>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.nombre}</div>
                            <div class="cart-item-brand">${item.marca}</div>
                            <div class="cart-item-price">S/ ${parseFloat(item.precio).toFixed(2)} c/u</div>
                            <div class="cart-item-controls">
                                <button class="qty-btn" onclick="cambiarCantidad(${index}, -1)">-</button>
                                <span class="qty-display">${item.cantidad}</span>
                                <button class="qty-btn" onclick="cambiarCantidad(${index}, 1)">+</button>
                                <button class="remove-btn" onclick="eliminarItem(${index})">Eliminar</button>
                            </div>
                        </div>
                        <div style="font-weight: 700; font-size: 1.2rem; color: var(--primary);">
                            S/ ${(item.precio * item.cantidad).toFixed(2)}
                        </div>
                    </div>
                `).join('')}
                
                <div class="cart-total">
                    <span class="cart-total-label">Total:</span>
                    <span class="cart-total-amount">S/ ${total.toFixed(2)}</span>
                </div>
                
                <form id="checkoutForm" onsubmit="realizarPedido(event)">
                    <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">Completa tus datos</h3>
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" id="nombreCliente" required>
                    </div>
                    <div class="form-group">
                        <label>Telefono (sin prefijo +51)</label>
                        <input type="tel" id="telefonoCliente" required placeholder="905820448">
                    </div>
                    <div class="form-group">
                        <label>Email (Opcional)</label>
                        <input type="email" id="emailCliente" placeholder="cliente@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label>Direccion de Entrega</label>
                        <textarea id="direccionCliente" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary" id="btnRealizarPedido">Realizar Pedido</button>
                </form>
            `;
        }

        function cambiarCantidad(index, cambio) {
            carrito[index].cantidad += cambio;
            if (carrito[index].cantidad <= 0) {
                carrito.splice(index, 1);
            }
            actualizarContadorCarrito();
            renderizarCarrito();
        }

        function eliminarItem(index) {
            carrito.splice(index, 1);
            actualizarContadorCarrito();
            renderizarCarrito();
        }

        async function realizarPedido(event) {
            event.preventDefault();
            
            const btnPedido = document.getElementById('btnRealizarPedido');
            btnPedido.disabled = true;
            btnPedido.textContent = 'Procesando pedido...';
            
            const nombre = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefonoCliente').value;
            const email = document.getElementById('emailCliente').value;
            const direccion = document.getElementById('direccionCliente').value;
            
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            
            const productosPedido = carrito.map(item => ({
                producto: item.nombre,
                marca: item.marca,
                cantidad: item.cantidad,
                precio_unitario: parseFloat(item.precio),
                subtotal: parseFloat(item.precio) * item.cantidad
            }));

            // --- Guardar en Supabase ---
            // IMPORTANTE: Debes crear una tabla `pedidos` en tu Supabase.
            // Ve a Table Editor -> Create a new table. Nómbrala 'pedidos'.
            // Desactiva 'Row Level Security (RLS)' para esta tabla por ahora para que funcione.
            // Columnas:
            // - id (bigint, primary key, auto-increment)
            // - created_at (timestamp with time zone, default now())
            // - nombre_cliente (text)
            // - telefono_cliente (text)
            // - email_cliente (text, nullable)
            // - direccion_cliente (text)
            // - productos (jsonb)
            // - total (numeric)
            // - estado (text, default 'Pendiente')
            const pedidoDB = {
                nombre_cliente: nombre,
                telefono_cliente: telefono,
                email_cliente: email || null,
                direccion_cliente: direccion,
                productos: productosPedido,
                total: parseFloat(total),
                estado: 'Pendiente'
            };

            try {
                const { error: supabaseError } = await supabaseClient
                    .from('pedidos')
                    .insert([pedidoDB]);

                if (supabaseError) {
                    console.error('Error al guardar pedido en Supabase:', supabaseError);
                    throw new Error('Error al guardar el pedido en la base de datos.');
                }
                
                // --- Enviar a n8n (si Supabase tuvo éxito) ---
                const pedidoN8N = {
                    ...pedidoDB,
                    fecha: new Date().toISOString()
                };

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pedidoN8N)
                });
                
                if (!response.ok) {
                    // Aunque n8n falle, el pedido ya está en Supabase, así que no es un error crítico para el usuario.
                    console.warn('El pedido se guardó en la base de datos, pero falló el envío al webhook n8n.');
                }
                
                document.getElementById('cartContent').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                
            } catch (error) {
                console.error('Error al procesar el pedido:', error);
                alert('Error al realizar el pedido. Por favor, intenta nuevamente. ' + error.message);
                btnPedido.disabled = false;
                btnPedido.textContent = 'Realizar Pedido';
            }
        }


        function cerrarYLimpiar() {
            carrito = [];
            actualizarContadorCarrito();
            cerrarCarrito();
        }

        async function cargarProductosAdmin() {
            if (!supabaseClient) return;

            document.getElementById('loadingAdmin').style.display = 'block';

            try {
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .order('nombre');

                if (error) throw error;

                const tbody = document.getElementById('adminProductsTable');
                tbody.innerHTML = (data || []).map(producto => `
                    <tr>
                        <td>
                            ${producto.imagen_url 
                                ? `<img src="${producto.imagen_url}" alt="${producto.nombre}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" onerror="this.style.display='none'">`
                                : '<span style="font-size: 0.8rem; color: #999;">Sin imagen</span>'
                            }
                        </td>
                        <td style="font-size: 1.5rem;">${producto.icon || '📦'}</td>
                        <td>${producto.nombre}</td>
                        <td>${producto.marca}</td>
                        <td>${getCategoriaName(producto.categoria)}</td>
                        <td>S/ ${parseFloat(producto.precio).toFixed(2)}</td>
                        <td>${producto.activo ? 'Activo' : 'Inactivo'}</td>
                        <td class="table-actions">
                            <button class="btn-edit" onclick="editarProducto(${producto.id})">Editar</button>
                            <button class="btn-danger" onclick="eliminarProducto(${producto.id})">Eliminar</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar productos: ' + error.message);
            } finally {
                document.getElementById('loadingAdmin').style.display = 'none';
            }
        }

        async function cargarPedidosAdmin() {
            if (!supabaseClient) return;

            document.getElementById('loadingAdminPedidos').style.display = 'block';

            try {
                const { data, error } = await supabaseClient
                    .from('pedidos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('adminOrdersTable');
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No hay pedidos registrados.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(pedido => `
                    <tr>
                        <td>${new Date(pedido.created_at).toLocaleDateString()}</td>
                        <td>${pedido.nombre_cliente}</td>
                        <td>${pedido.telefono_cliente}</td>
                        <td>S/ ${parseFloat(pedido.total).toFixed(2)}</td>
                        <td>${renderEstado(pedido.estado, pedido.id)}</td>
                        <td class="table-actions">
                            <button class="btn-secondary" onclick="mostrarDetallesPedido(${pedido.id})">Ver Detalles</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error al cargar pedidos:', error);
                document.getElementById('adminOrdersTable').innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--danger);">Error: ${error.message}</td></tr>`;
            } finally {
                document.getElementById('loadingAdminPedidos').style.display = 'none';
            }
        }

        function renderEstado(estado, pedidoId) {
            const estados = ['Pendiente', 'En Proceso', 'Completado', 'Cancelado'];
            return `
                <select class="status-select" onchange="actualizarEstadoPedido(${pedidoId}, this.value)">
                    ${estados.map(e => `<option value="${e}" ${e === estado ? 'selected' : ''}>${e}</option>`).join('')}
                </select>
            `;
        }

        async function actualizarEstadoPedido(pedidoId, nuevoEstado) {
            try {
                const { error } = await supabaseClient
                    .from('pedidos')
                    .update({ estado: nuevoEstado })
                    .eq('id', pedidoId);

                if (error) throw error;
                mostrarNotificacion(`Estado del pedido #${pedidoId} actualizado a "${nuevoEstado}"`);
            } catch (error) {
                console.error('Error al actualizar estado:', error);
                alert('Error al actualizar el estado: ' + error.message);
                cargarPedidosAdmin(); // Recargar para revertir el cambio visual
            }
        }

        async function mostrarDetallesPedido(id) {
            try {
                const { data, error } = await supabaseClient
                    .from('pedidos')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                const modal = document.getElementById('orderDetailsModal');
                const content = document.getElementById('orderDetailsContent');
                document.getElementById('orderDetailsTitle').textContent = `Detalles del Pedido #${data.id}`;

                content.innerHTML = `
                    <div class="order-details-grid">
                        <div class="order-details-card">
                            <h4>Datos del Cliente</h4>
                            <p><strong>Nombre:</strong> ${data.nombre_cliente}</p>
                            <p><strong>Teléfono:</strong> ${data.telefono_cliente}</p>
                            <p><strong>Email:</strong> ${data.email_cliente || 'No provisto'}</p>
                            <p><strong>Dirección:</strong> ${data.direccion_cliente}</p>
                        </div>
                        <div class="order-details-card">
                            <h4>Resumen del Pedido</h4>
                            <p><strong>Fecha:</strong> ${new Date(data.created_at).toLocaleString()}</p>
                            <p><strong>Estado:</strong> ${data.estado}</p>
                            <p><strong>Total:</strong> <strong style="font-size: 1.2rem; color: var(--primary);">S/ ${parseFloat(data.total).toFixed(2)}</strong></p>
                        </div>
                    </div>
                    <h4>Productos</h4>
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Marca</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.productos.map(p => `
                                <tr>
                                    <td>${p.producto}</td>
                                    <td>${p.marca}</td>
                                    <td>${p.cantidad}</td>
                                    <td>S/ ${parseFloat(p.precio_unitario).toFixed(2)}</td>
                                    <td>S/ ${parseFloat(p.subtotal).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error al cargar detalles del pedido:', error);
                alert('Error al cargar detalles del pedido: ' + error.message);
            }
        }

        function cerrarDetallesPedido() {
            document.getElementById('orderDetailsModal').style.display = 'none';
        }

        function abrirModalProducto() {
            document.getElementById('productoModalTitle').textContent = 'Agregar Producto';
            document.getElementById('productoForm').reset();
            document.getElementById('productoId').value = '';
            document.getElementById('productoActivo').checked = true;
            document.getElementById('imagePreview').innerHTML = '<span class="image-preview-text">🖼️</span>';
            document.getElementById('productoModal').style.display = 'block';
        }

        function cerrarModalProducto() {
            document.getElementById('productoModal').style.display = 'none';
        }

        async function editarProducto(id) {
            try {
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                document.getElementById('productoModalTitle').textContent = 'Editar Producto';
                document.getElementById('productoId').value = data.id;
                document.getElementById('productoNombre').value = data.nombre;
                document.getElementById('productoMarca').value = data.marca;
                document.getElementById('productoCategoria').value = data.categoria;
                document.getElementById('productoDescripcion').value = data.descripcion;
                document.getElementById('productoPrecio').value = data.precio;
                document.getElementById('productoIcon').value = data.icon || '';
                document.getElementById('productoBadge').value = data.badge || '';
                document.getElementById('productoActivo').checked = data.activo;
                document.getElementById('productoImagen').value = data.imagen_url || '';
                previewImagen();
                document.getElementById('productoModal').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar producto: ' + error.message);
            }
        }

        async function guardarProducto(event) {
            event.preventDefault();

            const id = document.getElementById('productoId').value;
            const producto = {
                nombre: document.getElementById('productoNombre').value,
                marca: document.getElementById('productoMarca').value,
                categoria: document.getElementById('productoCategoria').value,
                descripcion: document.getElementById('productoDescripcion').value,
                precio: parseFloat(document.getElementById('productoPrecio').value),
                icon: document.getElementById('productoIcon').value || '📦',
                badge: document.getElementById('productoBadge').value || null,
                activo: document.getElementById('productoActivo').checked,
                imagen_url: document.getElementById('productoImagen').value || null
            };

            try {
                if (id) {
                    const { error } = await supabaseClient
                        .from('productos')
                        .update(producto)
                        .eq('id', id);
                    
                    if (error) throw error;
                    alert('Producto actualizado exitosamente');
                } else {
                    const { error } = await supabaseClient
                        .from('productos')
                        .insert([producto]);
                    
                    if (error) throw error;
                    alert('Producto creado exitosamente');
                }

                cerrarModalProducto();
                cargarProductosAdmin();
                cargarProductos();

            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar producto: ' + error.message);
            }
        }

        async function eliminarProducto(id) {
            if (!confirm('Estas seguro de eliminar este producto?')) return;

            try {
                const { error } = await supabaseClient
                    .from('productos')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Producto eliminado exitosamente');
                cargarProductosAdmin();
                cargarProductos();

            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar producto: ' + error.message);
            }
        }

        function previewImagen() {
            const imagenUrl = document.getElementById('productoImagen').value;
            const preview = document.getElementById('imagePreview');
            
            if (imagenUrl) {
                const urlOptimizada = optimizarImagenUrl(imagenUrl);
                preview.innerHTML = `<img src="${urlOptimizada}" alt="Preview" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'image-preview-text\'>❌ URL inválida</span>'">`;
            } else {
                preview.innerHTML = '<span class="image-preview-text">🖼️</span>';
            }
        }

        async function subirImagenCloudinary(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen válido');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('La imagen es demasiado grande. Máximo 10MB');
                return;
            }

            const progressBar = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('uploadProgressBar');
            const preview = document.getElementById('imagePreview');
            
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
                formData.append('folder', 'red51/productos');

                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        progressFill.style.width = progress + '%';
                    }
                }, 100);

                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );

                clearInterval(progressInterval);

                if (!response.ok) {
                    throw new Error('Error al subir la imagen');
                }

                const data = await response.json();
                
                progressFill.style.width = '100%';
                
                const optimizedUrl = generarUrlOptimizada(data.public_id, data.format);
                
                document.getElementById('productoImagen').value = optimizedUrl;
                
                const thumbnailUrl = generarThumbnail(data.public_id, data.format);
                preview.innerHTML = `<img src="${thumbnailUrl}" alt="Preview">`;
                
                mostrarNotificacion('Imagen subida y optimizada exitosamente');
                
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 1000);

            } catch (error) {
                console.error('Error al subir imagen:', error);
                alert('Error al subir la imagen. Por favor intenta nuevamente.');
                progressBar.style.display = 'none';
            }

            event.target.value = '';
        }

        function generarUrlOptimizada(publicId, format) {
            return `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_fill,g_auto,q_auto,f_auto,w_600,h_450/${publicId}.${format}`;
        }

        function generarThumbnail(publicId, format) {
            return `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_thumb,g_face,q_auto,f_auto,w_200,h_200/${publicId}.${format}`;
        }

        function optimizarImagenUrl(url) {
            if (url && url.includes('res.cloudinary.com') && !url.includes('/upload/c_')) {
                const parts = url.split('/upload/');
                if (parts.length === 2) {
                    return parts[0] + '/upload/c_fill,g_auto,q_auto,f_auto,w_600,h_450/' + parts[1];
                }
            }
            return url;
        }

        function descargarPlantilla() {
            const csvContent = `nombre,marca,categoria,descripcion,precio,icon,badge,imagen_url,activo
iPhone 15 Pro,Apple,moviles,Smartphone premium con chip A17 Pro y cámara profesional,4599.00,📱,Nuevo,https://ejemplo.com/iphone15.jpg,true
AirPods Pro,Apple,audio,Auriculares con cancelación de ruido adaptativa,999.00,🎧,Popular,https://ejemplo.com/airpods.jpg,true
Echo Dot,Amazon,hogar,Altavoz inteligente con Alexa,199.00,🏠,,https://ejemplo.com/echo.jpg,true
MacBook Pro M3,Apple,computacion,Laptop profesional con chip M3 y pantalla Retina,7999.00,💻,Nuevo,https://ejemplo.com/macbook.jpg,true
PlayStation 5,Sony,entretenimiento,Consola de videojuegos de última generación,2499.00,🎮,Oferta,https://ejemplo.com/ps5.jpg,true`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'plantilla_productos_red51.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacion('Plantilla CSV descargada. Rellena con tus productos y luego importa.');
        }

        async function importarProductos(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    const productosImportados = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = lines[i].split(',').map(v => v.trim());
                        
                        if (values.length < headers.length) continue;
                        
                        const producto = {
                            nombre: values[0],
                            marca: values[1],
                            categoria: values[2],
                            descripcion: values[3],
                            precio: parseFloat(values[4]),
                            icon: values[5] || '📦',
                            badge: values[6] || null,
                            imagen_url: values[7] || null,
                            activo: values[8]?.toLowerCase() === 'true'
                        };
                        
                        if (producto.nombre && producto.marca && producto.categoria && producto.precio) {
                            productosImportados.push(producto);
                        }
                    }
                    
                    if (productosImportados.length === 0) {
                        alert('No se encontraron productos válidos en el archivo CSV');
                        return;
                    }
                    
                    if (!confirm(`Se importarán ${productosImportados.length} productos. ¿Continuar?`)) {
                        return;
                    }
                    
                    document.getElementById('loadingAdmin').style.display = 'block';
                    
                    const { data, error } = await supabaseClient
                        .from('productos')
                        .insert(productosImportados);
                    
                    if (error) throw error;
                    
                    alert(`${productosImportados.length} productos importados exitosamente`);
                    cargarProductosAdmin();
                    cargarProductos();
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al importar productos: ' + error.message);
                } finally {
                    document.getElementById('loadingAdmin').style.display = 'none';
                    event.target.value = '';
                }
            };
            
            reader.readAsText(file);
        }

        function mostrarNotificacion(mensaje) {
            const notif = document.createElement('div');
            notif.textContent = mensaje;
            notif.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                box-shadow: var(--shadow);
                z-index: 10000;
                font-weight: 600;
            `;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('cartModal')) {
                cerrarCarrito();
            }
            if (event.target == document.getElementById('productoModal')) {
                cerrarModalProducto();
            }
            if (event.target == document.getElementById('orderDetailsModal')) {
                cerrarDetallesPedido();
            }
        }

        inicializarSupabase();
        cargarProductos();
    </script>
</body>
</html>
